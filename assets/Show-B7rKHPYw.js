import{c as P,o as nn,a as Le,t as L,u as rn,b as tr,d as Kt,r as nr,e as Lt,i as E,f as x,m as we,F as Ae,S as Y,g as re,h as rr,j as ir,k as or,l as on,n as sn,p as bt,q as It,s as nt,v as sr,w as rt,x as lr,y as cr,P as ar,z as ur,A as hr,B as dr,C as fr,D as pr}from"./index-W2gUhlvN.js";const ln=e=>{let t=Object.keys(e.has_tags).length,n={...e.has_tags};return t>0&&(n.has_tag=!0,t===1?n.single_tag=!0:n.many_tags=!0),n[`id_${e.id}`]=!0,n},wt=e=>{let t={...e.tags,...ln(e)};if(e.rules){[...new Set(e.rules.flatMap(gr))].forEach(o=>t[o]=!0);let r=[],i=e.rules.filter(o=>o.solve===void 0||o.solve>=0);if(i.length>0){let o=i[0];o.solve===void 0?(r.push("matched"),r.push(`matched_${o.rule.name}`)):r.push("unmatched")}r.forEach(o=>t[o]=!0),i.length===1&&(t.single_attempt=!0)}return t},gr=e=>e.solve===void 0?(e.rule.rule.includes("."),["solved",`solved_${e.rule.name}`]):e.solve>=0?["failed",`failed_${e.rule.name}`]:[""],Bt=e=>t=>{let n=wt(t),[r,i]=e.split("_!_").map(s=>s.trim()),o=r===""?[]:r.split(" ");return i&&i.split(" ").find(l=>n[l])?!1:o.every(s=>n[s])},mr="/assets/hopefox-LFTqDWdf.wasm",br=["white","black"],Ie=["a","b","c","d","e","f","g","h"],Be=["1","2","3","4","5","6","7","8"],wr=[...Be].reverse(),vt=Array.prototype.concat(...Ie.map(e=>Be.map(t=>e+t))),U=e=>vt[8*e[0]+e[1]],M=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],cn=vt.map(M);function vr(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const kr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},kt=e=>e==="white"?"black":"white",Me=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},it=(e,t)=>e.role===t.role&&e.color===t.color,ze=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],Q=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},an=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},_t=(e,t)=>{e.style.visibility=t?"visible":"hidden"},fe=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},un=e=>e.button===2,ee=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function hn(e,t,n){const r=M(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const ue=(e,t)=>Math.abs(e-t),_r=e=>(t,n,r,i)=>ue(t,r)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===r:i===n-1||n>=6&&i===n-2&&t===r),dn=(e,t,n,r)=>{const i=ue(e,n),o=ue(t,r);return i===1&&o===2||i===2&&o===1},fn=(e,t,n,r)=>ue(e,n)===ue(t,r),pn=(e,t,n,r)=>e===n||t===r,gn=(e,t,n,r)=>fn(e,t,n,r)||pn(e,t,n,r),yr=(e,t,n)=>(r,i,o,s)=>ue(r,o)<2&&ue(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(r===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function Cr(e,t){const n=t==="white"?"1":"8",r=[];for(const[i,o]of e)i[1]===n&&o.color===t&&o.role==="rook"&&r.push(M(i)[0]);return r}function mn(e,t,n){const r=e.get(t);if(!r)return[];const i=M(t),o=r.role,s=o==="pawn"?_r(r.color):o==="knight"?dn:o==="bishop"?fn:o==="rook"?pn:o==="queen"?gn:yr(r.color,Cr(e,r.color),n);return cn.filter(l=>(i[0]!==l[0]||i[1]!==l[1])&&s(i[0],i[1],l[0],l[1])).map(U)}function H(e,...t){e&&setTimeout(()=>e(...t),1)}function $r(e){e.orientation=kt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Pr(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function Er(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function Sr(e,t,n,r){se(e),e.premovable.current=[t,n],H(e.premovable.events.set,t,n,r)}function oe(e){e.premovable.current&&(e.premovable.current=void 0,H(e.premovable.events.unset))}function xr(e,t,n){oe(e),e.predroppable.current={role:t,key:n},H(e.predroppable.events.set,t,n)}function se(e){const t=e.predroppable;t.current&&(t.current=void 0,H(t.events.unset))}function Ar(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const i=M(t),o=M(n);if(i[1]!==0&&i[1]!==7||i[1]!==o[1])return!1;i[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=U([7,o[1]]):o[0]===2&&(n=U([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<o[0]?(e.pieces.set(U([6,o[1]]),r),e.pieces.set(U([5,o[1]]),s)):(e.pieces.set(U([2,o[1]]),r),e.pieces.set(U([3,o[1]]),s)),!0)}function bn(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!r)return!1;const o=i&&i.color!==r.color?i:void 0;return n===e.selected&&G(e),H(e.events.move,t,n,o),Ar(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,H(e.events.change),o||!0}function yt(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return H(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,H(e.events.change),e.movable.dests=void 0,e.turnColor=kt(e.turnColor),!0}function wn(e,t,n){const r=bn(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=kt(e.turnColor),e.animation.current=void 0),r}function vn(e,t,n){if(Ct(e,t,n)){const r=wn(e,t,n);if(r){const i=e.hold.stop();G(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(o.captured=r),H(e.movable.events.after,t,n,o),!0}}else if(Rr(e,t,n))return Sr(e,t,n,{ctrlKey:e.stats.ctrlKey}),G(e),!0;return G(e),!1}function kn(e,t,n,r){const i=e.pieces.get(t);i&&(Mr(e,t,n)||r)?(e.pieces.delete(t),yt(e,i,n,r),H(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&Or(e,t,n)?xr(e,i.role,n):(oe(e),se(e)),e.pieces.delete(t),G(e)}function ot(e,t,n){if(H(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){G(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&vn(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(yn(e,t)||$t(e,t))&&(_n(e,t),e.hold.start())}function _n(e,t){e.selected=t,$t(e,t)?e.premovable.customDests||(e.premovable.dests=mn(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function yn(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const Ct=(e,t,n)=>{var r,i;return t!==n&&yn(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(n)))};function Mr(e,t,n){const r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function $t(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Rr(e,t,n){var r,i;const o=(i=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&i!==void 0?i:mn(e.pieces,t,e.premovable.castle);return t!==n&&$t(e,t)&&o.includes(n)}function Or(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function Tr(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function Nr(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let i=!1;if(Ct(e,n,r)){const o=wn(e,n,r);if(o){const s={premove:!0};o!==!0&&(s.captured=o),H(e.movable.events.after,n,r,s),i=!0}}return oe(e),i}function Dr(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(t(n)){const i={role:n.role,color:e.movable.color};yt(e,i,n.key)&&(H(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return se(e),r}function Pt(e){oe(e),se(e),G(e)}function Wt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Pt(e)}function pe(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?U([r,i]):void 0}function zr(e,t,n,r){const i=M(e),o=cn.filter(a=>gn(i[0],i[1],a[0],a[1])||dn(i[0],i[1],a[0],a[1])),l=o.map(a=>hn(U(a),n,r)).map(a=>Me(t,a)),[,c]=l.reduce((a,d,u)=>a[0]<d?a:[d,u],[l[0],0]);return U(o[c])}const q=e=>e.orientation==="white",Cn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Kr={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Lr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function $n(e){e==="start"&&(e=Cn);const t=new Map;let n=7,r=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const o=t.get(U([r-1,n]));o&&(o.promoted=!0);break}default:{const o=i.charCodeAt(0);if(o<57)r+=o-48;else{const s=i.toLowerCase();t.set(U([r,n]),{role:Kr[s],color:i===s?"black":"white"}),++r}}}return t}function Ir(e){return wr.map(t=>Ie.map(n=>{const r=e.get(n+t);if(r){let i=Lr[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Pn(e,t){t.animation&&(Et(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function En(e,t){var n,r,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),Et(e,t),t.fen&&(e.pieces=$n(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&Er(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&_n(e,e.selected),Pn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,l=e.movable.dests.get(s),c=e.pieces.get(s);if(!l||!c||c.role!=="king")return;e.movable.dests.set(s,l.filter(a=>!(a==="a"+o&&l.includes("c"+o))&&!(a==="h"+o&&l.includes("g"+o))))}}function Et(e,t){for(const n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&Ft(e[n])&&Ft(t[n])?Et(e[n],t[n]):e[n]=t[n])}function Ft(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const le=(e,t)=>t.animation.enabled?Fr(e,t):te(e,t);function te(e,t){const n=e(t);return t.dom.redraw(),n}const Ze=(e,t)=>({key:e,pos:M(e),piece:t}),Br=(e,t)=>t.sort((n,r)=>Me(e.pos,n.pos)-Me(e.pos,r.pos))[0];function Wr(e,t){const n=new Map,r=[],i=new Map,o=[],s=[],l=new Map;let c,a,d;for(const[u,b]of e)l.set(u,Ze(u,b));for(const u of vt)c=t.pieces.get(u),a=l.get(u),c?a?it(c,a.piece)||(o.push(a),s.push(Ze(u,c))):s.push(Ze(u,c)):a&&o.push(a);for(const u of s)a=Br(u,o.filter(b=>it(u.piece,b.piece))),a&&(d=[a.pos[0]-u.pos[0],a.pos[1]-u.pos[1]],n.set(u.key,d.concat(d)),r.push(a.key));for(const u of o)r.includes(u.key)||i.set(u.key,u.piece);return{anims:n,fadings:i}}function Sn(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=Hr(r);for(const o of n.plan.anims.values())o[2]=o[0]*i,o[3]=o[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Sn(e,o))}}function Fr(e,t){const n=new Map(t.pieces),r=e(t),i=Wr(n,t);if(i.anims.size||i.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},o||Sn(t,performance.now())}else t.dom.redraw();return r}const Hr=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,qr=["green","red","blue","yellow"];function jr(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):Pt(e);const n=fe(t),r=pe(n,q(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Qr(t),snapToValidMove:e.drawable.defaultSnapToValidMove},xn(e))}function xn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=pe(t.pos,q(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?zr(t.orig,t.pos,q(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),xn(e)}})}function Ur(e,t){e.drawable.current&&(e.drawable.current.pos=fe(t))}function Gr(e){const t=e.drawable.current;t&&(t.mouseSq&&Zr(e.drawable,t),An(e))}function An(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Vr(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),Mn(e.drawable))}function Qr(e){var t;const n=(e.shiftKey||e.ctrlKey)&&un(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return qr[(n?1:0)+(r?2:0)]}function Zr(e,t){const n=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(i=>!n(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),Mn(e)}function Mn(e){e.onChange&&e.onChange(e.shapes)}function Yr(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=fe(t),i=pe(r,q(e),n);if(!i)return;const o=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Vr(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Xr(e,r)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Ct(e,e.selected,i)?le(u=>ot(u,i),e):ot(e,i);const a=e.selected===i,d=On(e,i);if(o&&d&&a&&Tr(e,i)){e.draggable.current={orig:i,piece:o,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:d,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},d.cgDragging=!0,d.classList.add("dragging");const u=e.dom.elements.ghost;u&&(u.className=`ghost ${o.color} ${o.role}`,Q(u,ze(n)(M(i),q(e))),_t(u,!0)),St(e)}else l&&oe(e),c&&se(e);e.dom.redraw()}function Xr(e,t){const n=q(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(const o of e.pieces.keys()){const s=hn(o,n,r);if(Me(s,t)<=i)return!0}return!1}function Jr(e,t,n,r){const i="a0";e.pieces.set(i,t),e.dom.redraw();const o=fe(n);e.draggable.current={orig:i,piece:t,origPos:o,pos:o,started:!0,element:()=>On(e,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},St(e)}function St(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!it(r,n.piece))We(e);else if(!n.started&&Me(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const i=e.dom.bounds();Q(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==pe(n.pos,q(e),i))}St(e)})}function ei(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=fe(t))}function ti(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}oe(e),se(e);const r=fe(t)||n.pos,i=pe(r,q(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?kn(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,vn(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),H(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?G(e):e.selectable.enabled||G(e),Rn(e),e.draggable.current=void 0,e.dom.redraw()}function We(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),Rn(e),e.dom.redraw())}function Rn(e){const t=e.dom.elements;t.ghost&&_t(t.ghost,!1)}function On(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function ni(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Ht(e,2),setTimeout(()=>Ht(e,void 0),120)},120)}function Ht(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function ri(e,t){function n(){$r(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),Pn(e,r),(r.fen?le:te)(i=>En(i,r),e)},state:e,getFen:()=>Ir(e.pieces),toggleOrientation:n,setPieces(r){le(i=>Pr(i,r),e)},selectSquare(r,i){r?le(o=>ot(o,r,i),e):e.selected&&(G(e),e.dom.redraw())},move(r,i){le(o=>bn(o,r,i),e)},newPiece(r,i){le(o=>yt(o,r,i),e)},playPremove(){if(e.premovable.current){if(le(Nr,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const i=Dr(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){te(oe,e)},cancelPredrop(){te(se,e)},cancelMove(){te(r=>{Pt(r),We(r)},e)},stop(){te(r=>{Wt(r),We(r)},e)},explode(r){ni(e,r)},setAutoShapes(r){te(i=>i.drawable.autoShapes=r,e)},setShapes(r){te(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return pe(r,q(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,o){Jr(e,r,i,o)},destroy(){Wt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function ii(){return{pieces:$n(Cn),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:kr()}}const qt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function oi(){const e=K("defs"),t=W(K("filter"),{id:"cg-filter-blur"});return t.appendChild(W(K("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function si(e,t,n){var r;const i=e.drawable,o=i.current,s=o&&o.mouseSq?o:void 0,l=new Map,c=e.dom.bounds(),a=i.autoShapes.filter(w=>!w.piece);for(const w of i.shapes.concat(a).concat(s?[s]:[])){if(!w.dest)continue;const p=(r=l.get(w.dest))!==null&&r!==void 0?r:new Set,f=qe(He(M(w.orig),e.orientation),c),y=qe(He(M(w.dest),e.orientation),c);p.add(lt(f,y)),l.set(w.dest,p)}const d=i.shapes.concat(a).map(w=>({shape:w,current:!1,hash:jt(w,st(w.dest,l),!1,c)}));s&&d.push({shape:s,current:!0,hash:jt(s,st(s.dest,l),!0,c)});const u=d.map(w=>w.hash).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const b=t.querySelector("defs");li(i,d,b),ci(d,t.querySelector("g"),n.querySelector("g"),w=>hi(e,w,i.brushes,l,c))}function li(e,t,n){var r;const i=new Map;let o;for(const c of t.filter(a=>a.shape.dest&&a.shape.brush))o=Tn(e.brushes[c.shape.brush],c.shape.modifiers),!((r=c.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(Fe(o).key,Fe(o)),i.set(o.key,o);const s=new Set;let l=n.firstElementChild;for(;l;)s.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(const[c,a]of i.entries())s.has(c)||n.appendChild(pi(a))}function ci(e,t,n,r){const i=new Map;for(const o of e)i.set(o.hash,!1);for(const o of[t,n]){const s=[];let l=o.firstElementChild,c;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):s.push(l),l=l.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!i.get(s.hash)))for(const s of r(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function jt({orig:e,dest:t,brush:n,piece:r,modifiers:i,customSvg:o,label:s},l,c,a){var d,u;return[a.width,a.height,c,e,t,n,l&&"-",r&&ai(r),i&&ui(i),o&&`custom-${Ut(o.html)},${(u=(d=o.center)===null||d===void 0?void 0:d[0])!==null&&u!==void 0?u:"o"}`,s&&`label-${Ut(s.text)}`].filter(b=>b).join(",")}function ai(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function ui(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Ut(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function hi(e,{shape:t,current:n,hash:r},i,o,s){var l,c;const a=qe(He(M(t.orig),e.orientation),s),d=t.dest?qe(He(M(t.dest),e.orientation),s):a,u=t.brush&&Tn(i[t.brush],t.modifiers),b=o.get(t.dest),w=[];if(u){const p=W(K("g"),{cgHash:r});w.push({el:p}),a[0]!==d[0]||a[1]!==d[1]?p.appendChild(fi(t,u,a,d,n,st(t.dest,o))):p.appendChild(di(i[t.brush],a,n,s))}if(t.label){const p=t.label;(l=p.fill)!==null&&l!==void 0||(p.fill=t.brush&&i[t.brush].color);const f=t.brush?void 0:"tr";w.push({el:gi(p,r,a,d,b,f),isCustom:!0})}if(t.customSvg){const p=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[f,y]=p==="label"?Dn(a,d,b).map(g=>g-.5):p==="dest"?d:a,m=W(K("g"),{transform:`translate(${f},${y})`,cgHash:r});m.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,w.push({el:m,isCustom:!0})}return w}function di(e,t,n,r){const i=mi(),o=(r.width+r.height)/(4*Math.max(r.width,r.height));return W(K("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:Nn(e,n),cx:t[0],cy:t[1],r:o-i[1]/2})}function Fe(e){return["#ffffff","#fff","white"].includes(e.color)?qt.hilitePrimary:qt.hiliteWhite}function fi(e,t,n,r,i,o){var s;function l(d){var u;const b=wi(o&&!i),w=r[0]-n[0],p=r[1]-n[1],f=Math.atan2(p,w),y=Math.cos(f)*b,m=Math.sin(f)*b;return W(K("line"),{stroke:d?Fe(t).color:t.color,"stroke-width":bi(t,i)+(d?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${d?Fe(t).key:t.key})`,opacity:!((u=e.modifiers)===null||u===void 0)&&u.hilite?1:Nn(t,i),x1:n[0],y1:n[1],x2:r[0]-y,y2:r[1]-m})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return l(!1);const c=K("g"),a=W(K("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(vi(n,r)),a.appendChild(l(!0)),c.appendChild(a),c.appendChild(l(!1)),c}function pi(e){const t=W(K("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(W(K("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function gi(e,t,n,r,i,o){var s;const c=.4*.75**e.text.length,a=Dn(n,r,i),d=o==="tr"?.4:0,u=W(K("g"),{transform:`translate(${a[0]+d},${a[1]-d})`,cgHash:t});u.appendChild(W(K("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const b=W(K("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return b.innerHTML=e.text,u.appendChild(b),u}function He(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function st(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function K(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function W(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function Tn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function mi(){return[3/64,4/64]}function bi(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Nn(e,t){return(e.opacity||1)*(t?.9:1)}function wi(e){return(e?20:10)/64}function qe(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function vi(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return W(K("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function lt(e,t,n=!0){const r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function ki(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function Dn(e,t,n){let r=ki(e,t);const i=lt(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const o=lt(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(r-=.4)}return[e[0]-Math.cos(i)*r,e[1]-Math.sin(i)*r].map(o=>o+.5)}function _i(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of br)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=ee("cg-container");e.appendChild(n);const r=ee("cg-board");n.appendChild(r);let i,o,s;if(t.drawable.visible&&(i=W(K("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(oi()),i.appendChild(K("g")),o=W(K("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(K("g")),s=ee("cg-auto-pieces"),n.appendChild(i),n.appendChild(o),n.appendChild(s)),t.coordinates){const c=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const d=t.orientation==="white"?u=>u+1:u=>8-u;Ie.forEach((u,b)=>n.appendChild(Ye(Be.map(w=>u+w),"squares rank"+d(b)+c+a)))}else n.appendChild(Ye(Be,"ranks"+c+a)),n.appendChild(Ye(Ie,"files"+c))}let l;return t.draggable.enabled&&t.draggable.showGhost&&(l=ee("piece","ghost"),_t(l,!1),n.appendChild(l)),{board:r,container:n,wrap:e,ghost:l,svg:i,customSvg:o,autoPieces:s}}function Ye(e,t){const n=ee("coords",t);let r;for(const i of e)r=ee("coord"),r.textContent=i,n.appendChild(r);return n}function yi(e,t){if(!e.dropmode.active)return;oe(e),se(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=fe(t),i=r&&pe(r,q(e),e.dom.bounds());i&&kn(e,"a0",i)}e.dom.redraw()}function Ci(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const r=Pi(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function $i(e,t){const n=[];if("ResizeObserver"in window||n.push(Ee(document.body,"chessground.resize",t)),!e.viewOnly){const r=Gt(e,ei,Ur),i=Gt(e,ti,Gr);for(const s of["touchmove","mousemove"])n.push(Ee(document,s,r));for(const s of["touchend","mouseup"])n.push(Ee(document,s,i));const o=()=>e.dom.bounds.clear();n.push(Ee(document,"scroll",o,{capture:!0,passive:!0})),n.push(Ee(window,"resize",o,{passive:!0}))}return()=>n.forEach(r=>r())}function Ee(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}const Pi=e=>t=>{e.draggable.current?We(e):e.drawable.current?An(e):t.shiftKey||un(t)?e.drawable.enabled&&jr(e,t):e.viewOnly||(e.dropmode.active?yi(e,t):Yr(e,t))},Gt=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function Ei(e){const t=q(e),n=ze(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,l=o?o.plan.fadings:new Map,c=e.draggable.current,a=xi(e),d=new Set,u=new Set,b=new Map,w=new Map;let p,f,y,m,g,S,O,$,D,v;for(f=r.firstChild;f;){if(p=f.cgKey,zn(f))if(y=i.get(p),g=s.get(p),S=l.get(p),m=f.cgPiece,f.cgDragging&&(!c||c.orig!==p)&&(f.classList.remove("dragging"),Q(f,n(M(p),t)),f.cgDragging=!1),!S&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),y){if(g&&f.cgAnimating&&m===Se(y)){const C=M(p);C[0]+=g[2],C[1]+=g[3],f.classList.add("anim"),Q(f,n(C,t))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),Q(f,n(M(p),t)),e.addPieceZIndex&&(f.style.zIndex=Xe(M(p),t)));m===Se(y)&&(!S||!f.cgFading)?d.add(p):S&&m===Se(S)?(f.classList.add("fading"),f.cgFading=!0):Je(b,m,f)}else Je(b,m,f);else if(Kn(f)){const C=f.className;a.get(p)===C?u.add(p):Je(w,C,f)}f=f.nextSibling}for(const[C,A]of a)if(!u.has(C)){D=w.get(A),v=D&&D.pop();const R=n(M(C),t);if(v)v.cgKey=C,Q(v,R);else{const T=ee("square",A);T.cgKey=C,Q(T,R),r.insertBefore(T,r.firstChild)}}for(const[C,A]of i)if(g=s.get(C),!d.has(C))if(O=b.get(Se(A)),$=O&&O.pop(),$){$.cgKey=C,$.cgFading&&($.classList.remove("fading"),$.cgFading=!1);const R=M(C);e.addPieceZIndex&&($.style.zIndex=Xe(R,t)),g&&($.cgAnimating=!0,$.classList.add("anim"),R[0]+=g[2],R[1]+=g[3]),Q($,n(R,t))}else{const R=Se(A),T=ee("piece",R),F=M(C);T.cgPiece=R,T.cgKey=C,g&&(T.cgAnimating=!0,F[0]+=g[2],F[1]+=g[3]),Q(T,n(F,t)),e.addPieceZIndex&&(T.style.zIndex=Xe(F,t)),r.appendChild(T)}for(const C of b.values())Qt(e,C);for(const C of w.values())Qt(e,C)}function Si(e){const t=q(e),n=ze(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(zn(r)&&!r.cgAnimating||Kn(r))&&Q(r,n(M(r.cgKey),t)),r=r.nextSibling}function Vt(e){var t,n;const r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,o=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=s*o;i.style.width=s+"px",i.style.height=l+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",l+"px")}const zn=e=>e.tagName==="PIECE",Kn=e=>e.tagName==="SQUARE";function Qt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Xe(e,t){const r=e[1];return`${t?10-r:3+r}`}const Se=e=>`${e.color} ${e.role}`;function xi(e){var t,n,r;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const l of e.lastMove)X(i,l,"last-move");if(e.check&&e.highlight.check&&X(i,e.check,"check"),e.selected&&(X(i,e.selected,"selected"),e.movable.showDests)){const l=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(l)for(const a of l)X(i,a,"move-dest"+(e.pieces.has(a)?" oc":""));const c=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(c)for(const a of c)X(i,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const l of o)X(i,l,"current-premove");else e.predroppable.current&&X(i,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const l of s.keys)X(i,l,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((l,c)=>{X(i,c,l)}),i}function X(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function Je(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function Ai(e,t,n){const r=new Map,i=[];for(const l of e)r.set(l.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),r.has(s)?r.set(s,!0):i.push(o),o=o.nextElementSibling;for(const l of i)t.removeChild(l);for(const l of e)r.get(l.hash)||t.appendChild(n(l))}function Mi(e,t){const r=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Ti(i),current:!1}));Ai(r,t,i=>Oi(e,i,e.dom.bounds()))}function Ri(e){var t;const n=q(e),r=ze(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)an(i,r(M(i.cgKey),n),i.cgScale),i=i.nextSibling}function Oi(e,{shape:t,hash:n},r){var i,o,s;const l=t.orig,c=(i=t.piece)===null||i===void 0?void 0:i.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,d=(s=t.piece)===null||s===void 0?void 0:s.scale,u=ee("piece",`${c} ${a}`);return u.setAttribute("cgHash",n),u.cgKey=l,u.cgScale=d,an(u,ze(r)(M(l),q(e)),d),u}const Ti=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function Ni(e,t){const n=ii();En(n,t||{});function r(){const i="dom"in n?n.dom.unbind:void 0,o=_i(e,n),s=vr(()=>o.board.getBoundingClientRect()),l=d=>{Ei(a),o.autoPieces&&Mi(a,o.autoPieces),!d&&o.svg&&si(a,o.svg,o.customSvg)},c=()=>{Vt(a),Si(a),o.autoPieces&&Ri(a)},a=n;return a.dom={elements:o,bounds:s,redraw:Di(l),redrawNow:l,unbind:i},a.drawable.prevSvgHash="",Vt(a),l(!1),Ci(a,c),i||(a.dom.unbind=$i(a,c)),a.events.insert&&a.events.insert(o),a}return ri(r(),r)}function Di(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}const je=["a","b","c","d","e","f","g","h"],Ln=["1","2","3","4","5","6","7","8"],he=["white","black"],V=["pawn","knight","bishop","rook","queen","king"],zi=["a","h"],Ue=e=>"role"in e,k=e=>e!==void 0,B=e=>e==="white"?"black":"white",de=e=>e>>3,j=e=>e&7,ct=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,xe=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function at(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function Ke(e){if(e.length===2)return ct(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const Re=e=>je[j(e)]+Ln[de(e)],Ki=e=>{if(e[1]==="@"&&e.length===4){const t=at(e[0]),n=Ke(e.slice(2));if(t&&k(n))return{role:t,to:n}}else if(e.length===4||e.length===5){const t=Ke(e.slice(0,2)),n=Ke(e.slice(2,4));let r;if(e.length===5&&(r=at(e[4]),!r))return;if(k(t)&&k(n))return{from:t,to:n,promotion:r}}},xt=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,At=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61,Zt=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),ut=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),Yt=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,ut(e));class h{constructor(t,n){this.lo=t|0,this.hi=n|0}static fromSquare(t){return t>=32?new h(0,1<<t-32):new h(1<<t,0)}static fromRank(t){return new h(255,0).shl64(8*t)}static fromFile(t){return new h(16843009<<t,16843009<<t)}static empty(){return new h(0,0)}static full(){return new h(4294967295,4294967295)}static corners(){return new h(129,2164260864)}static center(){return new h(402653184,24)}static backranks(){return new h(255,4278190080)}static backrank(t){return t==="white"?new h(255,0):new h(0,4278190080)}static lightSquares(){return new h(1437226410,1437226410)}static darkSquares(){return new h(2857740885,2857740885)}complement(){return new h(~this.lo,~this.hi)}xor(t){return new h(this.lo^t.lo,this.hi^t.hi)}union(t){return new h(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new h(this.lo&t.lo,this.hi&t.hi)}diff(t){return new h(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?h.empty():t>=32?new h(this.hi>>>t-32,0):t>0?new h(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?h.empty():t>=32?new h(0,this.lo<<t-32):t>0?new h(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new h(ut(this.hi),ut(this.lo))}rbit64(){return new h(Yt(this.hi),Yt(this.lo))}minus64(t){const n=this.lo-t.lo,r=(n&t.lo&1)+(t.lo>>>1)+(n>>>1)>>>31;return new h(n,this.hi-(t.hi+r))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return Zt(this.lo)+Zt(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,n){return n?this.with(t):this.without(t)}with(t){return t>=32?new h(this.lo,this.hi|1<<t-32):new h(this.lo|1<<t,this.hi)}without(t){return t>=32?new h(this.lo,this.hi&~(1<<t-32)):new h(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new h(this.lo,this.hi^1<<t-32):new h(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new h(this.lo&this.lo-1,this.hi):new h(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,n=this.hi;for(;t!==0;){const r=31-Math.clz32(t&-t);t^=1<<r,yield r}for(;n!==0;){const r=31-Math.clz32(n&-n);n^=1<<r,yield 32+r}}*reversed(){let t=this.lo,n=this.hi;for(;n!==0;){const r=31-Math.clz32(n);n^=1<<r,yield 32+r}for(;t!==0;){const r=31-Math.clz32(t);t^=1<<r,yield r}}}const Ge=(e,t)=>{let n=h.empty();for(const r of t){const i=e+r;0<=i&&i<64&&Math.abs(j(e)-j(i))<=2&&(n=n.with(i))}return n},ie=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},Li=ie(e=>Ge(e,[-9,-8,-7,-1,1,7,8,9])),Ii=ie(e=>Ge(e,[-17,-15,-10,-6,6,10,15,17])),Bi={white:ie(e=>Ge(e,[7,9])),black:ie(e=>Ge(e,[-7,-9]))},Mt=e=>Li[e],Rt=e=>Ii[e],Ve=(e,t)=>Bi[e][t],ht=ie(e=>h.fromFile(j(e)).without(e)),dt=ie(e=>h.fromRank(de(e)).without(e)),ft=ie(e=>{const t=new h(134480385,2151686160),n=8*(de(e)-j(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),pt=ie(e=>{const t=new h(270549120,16909320),n=8*(de(e)+j(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),gt=(e,t,n)=>{let r=n.intersect(t),i=r.bswap64();return r=r.minus64(e),i=i.minus64(e.bswap64()),r.xor(i.bswap64()).intersect(t)},Wi=(e,t)=>gt(h.fromSquare(e),ht[e],t),Fi=(e,t)=>{const n=dt[e];let r=t.intersect(n),i=r.rbit64();return r=r.minus64(h.fromSquare(e)),i=i.minus64(h.fromSquare(63-e)),r.xor(i.rbit64()).intersect(n)},Oe=(e,t)=>{const n=h.fromSquare(e);return gt(n,ft[e],t).xor(gt(n,pt[e],t))},Te=(e,t)=>Wi(e,t).xor(Fi(e,t)),In=(e,t)=>Oe(e,t).xor(Te(e,t)),Bn=(e,t)=>{const n=h.fromSquare(t);return dt[e].intersects(n)?dt[e].with(e):pt[e].intersects(n)?pt[e].with(e):ft[e].intersects(n)?ft[e].with(e):ht[e].intersects(n)?ht[e].with(e):h.empty()},Ne=(e,t)=>Bn(e,t).intersect(h.full().shl64(e).xor(h.full().shl64(t))).withoutFirst();class _e{constructor(){}static default(){const t=new _e;return t.reset(),t}reset(){this.occupied=new h(65535,4294901760),this.promoted=h.empty(),this.white=new h(65535,0),this.black=new h(0,4294901760),this.pawn=new h(65280,16711680),this.knight=new h(66,1107296256),this.bishop=new h(36,603979776),this.rook=new h(129,2164260864),this.queen=new h(8,134217728),this.king=new h(16,268435456)}static empty(){const t=new _e;return t.clear(),t}clear(){this.occupied=h.empty(),this.promoted=h.empty();for(const t of he)this[t]=h.empty();for(const t of V)this[t]=h.empty()}clone(){const t=new _e;t.occupied=this.occupied,t.promoted=this.promoted;for(const n of he)t[n]=this[n];for(const n of V)t[n]=this[n];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const n of V)if(this[n].has(t))return n}get(t){const n=this.getColor(t);if(!n)return;const r=this.getRole(t),i=this.promoted.has(t);return{color:n,role:r,promoted:i}}take(t){const n=this.get(t);return n&&(this.occupied=this.occupied.without(t),this[n.color]=this[n.color].without(t),this[n.role]=this[n.role].without(t),n.promoted&&(this.promoted=this.promoted.without(t))),n}set(t,n){const r=this.take(t);return this.occupied=this.occupied.with(t),this[n.color]=this[n.color].with(t),this[n.role]=this[n.role].with(t),n.promoted&&(this.promoted=this.promoted.with(t)),r}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,n){return this[t].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class Z{constructor(){}static empty(){const t=new Z;for(const n of V)t[n]=0;return t}static fromBoard(t,n){const r=new Z;for(const i of V)r[i]=t.pieces(n,i).size();return r}clone(){const t=new Z;for(const n of V)t[n]=this[n];return t}equals(t){return V.every(n=>this[n]===t[n])}add(t){const n=new Z;for(const r of V)n[r]=this[r]+t[r];return n}subtract(t){const n=new Z;for(const r of V)n[r]=this[r]-t[r];return n}nonEmpty(){return V.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class ce{constructor(t,n){this.white=t,this.black=n}static empty(){return new ce(Z.empty(),Z.empty())}static fromBoard(t){return new ce(Z.fromBoard(t,"white"),Z.fromBoard(t,"black"))}clone(){return new ce(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new ce(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new ce(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class De{constructor(t,n){this.white=t,this.black=n}static default(){return new De(3,3)}clone(){return new De(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}class Wn{unwrap(t,n){const r=this._chain(i=>_.ok(t?t(i):i),i=>n?_.ok(n(i)):_.err(i));if(r.isErr)throw r.error;return r.value}map(t,n){return this._chain(r=>_.ok(t(r)),r=>_.err(n?n(r):r))}chain(t,n){return this._chain(t,n||(r=>_.err(r)))}}class Hi extends Wn{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,n){return t(this.value)}}class qi extends Wn{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,n){return n(this.error)}}var _;(function(e){e.ok=function(t){return new Hi(t)},e.err=function(t){return new qi(t||new Error)},e.all=function(t){if(Array.isArray(t)){const i=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;i.push(s.value)}return e.ok(i)}const n={},r=Object.keys(t);for(let i=0;i<r.length;i++){const o=t[r[i]];if(o.isErr)return o;n[r[i]]=o.value}return e.ok(n)}})(_||(_={}));var ne;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(ne||(ne={}));class me extends Error{}const ji=(e,t,n,r)=>n[t].intersect(Te(e,r).intersect(n.rooksAndQueens()).union(Oe(e,r).intersect(n.bishopsAndQueens())).union(Rt(e).intersect(n.knight)).union(Mt(e).intersect(n.king)).union(Ve(B(t),e).intersect(n.pawn)));class ae{constructor(){}static default(){const t=new ae;return t.castlingRights=h.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new h(14,0),h:new h(96,0)},black:{a:new h(0,234881024),h:new h(0,1610612736)}},t}static empty(){const t=new ae;return t.castlingRights=h.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:h.empty(),h:h.empty()},black:{a:h.empty(),h:h.empty()}},t}clone(){const t=new ae;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,n,r,i){const o=xt(t,n),s=At(t,n);this.castlingRights=this.castlingRights.with(i),this.rook[t][n]=i,this.path[t][n]=Ne(i,s).with(s).union(Ne(r,o).with(o)).without(r).without(i)}static fromSetup(t){const n=ae.empty(),r=t.castlingRights.intersect(t.board.rook);for(const i of he){const o=h.backrank(i),s=t.board.kingOf(i);if(!k(s)||!o.has(s))continue;const l=r.intersect(t.board[i]).intersect(o),c=l.first();k(c)&&c<s&&n.add(i,"a",s,c);const a=l.last();k(a)&&s<a&&n.add(i,"h",s,a)}return n}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const n of he)for(const r of zi)this.rook[n][r]===t&&(this.rook[n][r]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(h.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Ui{constructor(t){this.rules=t}reset(){this.board=_e.default(),this.pockets=void 0,this.turn="white",this.castles=ae.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=h.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=ae.fromSetup(t),this.epSquare=Gi(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,n,r){return ji(t,n,this.board,r)}playCaptureAt(t,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[B(n.color)][n.promoted?"pawn":n.role]++}ctx(){const t=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!k(n))return{king:n,blockers:h.empty(),checkers:h.empty(),variantEnd:t,mustCapture:!1};const r=Te(n,h.empty()).intersect(this.board.rooksAndQueens()).union(Oe(n,h.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[B(this.turn)]);let i=h.empty();for(const s of r){const l=Ne(n,s).intersect(this.board.occupied);l.moreThanOne()||(i=i.union(l))}const o=this.kingAttackers(n,B(this.turn),this.board.occupied);return{king:n,blockers:i,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,n;const r=new this.constructor;return r.board=this.board.clone(),r.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),r.turn=this.turn,r.castles=this.castles.clone(),r.epSquare=this.epSquare,r.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),r.halfmoves=this.halfmoves,r.fullmoves=this.fullmoves,r}validate(){if(this.board.occupied.isEmpty())return _.err(new me(ne.Empty));if(this.board.king.size()!==2)return _.err(new me(ne.Kings));if(!k(this.board.kingOf(this.turn)))return _.err(new me(ne.Kings));const t=this.board.kingOf(B(this.turn));return k(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?_.err(new me(ne.OppositeCheck)):h.backranks().intersects(this.board.pawn)?_.err(new me(ne.PawnsOnBackrank)):_.ok(void 0):_.err(new me(ne.Kings))}dropDests(t){return h.empty()}dests(t,n){if(n=n||this.ctx(),n.variantEnd)return h.empty();const r=this.board.get(t);if(!r||r.color!==this.turn)return h.empty();let i,o;if(r.role==="pawn"){i=Ve(this.turn,t).intersect(this.board[B(this.turn)]);const s=this.turn==="white"?8:-8,l=t+s;if(0<=l&&l<64&&!this.board.occupied.has(l)){i=i.with(l);const c=this.turn==="white"?t<16:t>=48,a=l+s;c&&!this.board.occupied.has(a)&&(i=i.with(a))}k(this.epSquare)&&Qi(this,t,n)&&(o=h.fromSquare(this.epSquare))}else r.role==="bishop"?i=Oe(t,this.board.occupied):r.role==="knight"?i=Rt(t):r.role==="rook"?i=Te(t,this.board.occupied):r.role==="queen"?i=In(t,this.board.occupied):i=Mt(t);if(i=i.diff(this.board[this.turn]),k(n.king)){if(r.role==="king"){const s=this.board.occupied.without(t);for(const l of i)this.kingAttackers(l,B(this.turn),s).nonEmpty()&&(i=i.without(l));return i.union(Xt(this,"a",n)).union(Xt(this,"h",n))}if(n.checkers.nonEmpty()){const s=n.checkers.singleSquare();if(!k(s))return h.empty();i=i.intersect(Ne(s,n.king).with(s))}n.blockers.has(t)&&(i=i.intersect(Bn(t,n.king)))}return o&&(i=i.union(o)),i}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[B(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(h.darkSquares())||!this.board.bishop.intersects(h.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,n;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:Vi(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return he.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,n){if(Ue(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&h.backranks().has(t.to)?!1:this.dropDests(n).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&h.backranks().has(t.to)))return!1;const r=this.dests(t.from,n);return r.has(t.to)||r.has(Zi(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return k(t)&&this.kingAttackers(t,B(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const n=this.variantOutcome(t);return n||(t=t||this.ctx(),this.isCheckmate(t)?{winner:B(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const n=new Map;if(t.variantEnd)return n;for(const r of this.board[this.turn])n.set(r,this.dests(r,t));return n}play(t){const n=this.turn,r=this.epSquare,i=Hn(this,t);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=B(n),Ue(t))this.board.set(t.to,{role:t.role,color:n}),this.pockets&&this.pockets[n][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===r&&(s=this.board.take(t.to+(n==="white"?-8:8)));const l=t.from-t.to;Math.abs(l)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(i){const l=this.castles.rook[n][i];if(k(l)){const c=this.board.take(l);this.board.set(xt(n,i),o),c&&this.board.set(At(n,i),c)}}this.castles.discardColor(n)}if(!i){const l=this.board.set(t.to,o)||s;l&&this.playCaptureAt(t.to,l)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class Fn extends Ui{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(r=>n)}clone(){return super.clone()}}const Gi=(e,t)=>{if(!k(t))return;const n=e.turn==="white"?5:2,r=e.turn==="white"?8:-8;if(de(t)!==n||e.board.occupied.has(t+r))return;const i=t-r;if(!(!e.board.pawn.has(i)||!e.board[B(e.turn)].has(i)))return t},Vi=e=>{if(!k(e.epSquare))return;const t=e.ctx(),r=e.board.pieces(e.turn,"pawn").intersect(Ve(B(e.turn),e.epSquare));for(const i of r)if(e.dests(i,t).has(e.epSquare))return e.epSquare},Qi=(e,t,n)=>{if(!k(e.epSquare)||!Ve(e.turn,t).has(e.epSquare))return!1;if(!k(n.king))return!0;const r=e.turn==="white"?8:-8,i=e.epSquare-r;return e.kingAttackers(n.king,B(e.turn),e.board.occupied.toggle(t).toggle(i).with(e.epSquare)).without(i).isEmpty()},Xt=(e,t,n)=>{if(!k(n.king)||n.checkers.nonEmpty())return h.empty();const r=e.castles.rook[e.turn][t];if(!k(r)||e.castles.path[e.turn][t].intersects(e.board.occupied))return h.empty();const i=xt(e.turn,t),o=Ne(n.king,i),s=e.board.occupied.without(n.king);for(const a of o)if(e.kingAttackers(a,B(e.turn),s).nonEmpty())return h.empty();const l=At(e.turn,t),c=e.board.occupied.toggle(n.king).toggle(r).toggle(l);return e.kingAttackers(i,B(e.turn),c).nonEmpty()?h.empty():h.fromSquare(r)},Hn=(e,t)=>{if(Ue(t))return;const n=t.to-t.from;if(!(Math.abs(n)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return n>0?"h":"a"},Zi=(e,t)=>{const n=Hn(e,t);if(!n)return t;const r=e.castles.rook[e.turn][n];return{from:t.from,to:k(r)?r:t.to}},Yi=(e,t)=>{const n=new Map,r=e.ctx();for(const[i,o]of e.allDests(r))if(o.nonEmpty()){const s=Array.from(o,Re);i===r.king&&j(i)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(Re(i),s)}return n},Xi="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Ji=Xi+" w KQkq -",Ot=Ji+" 0 1";var z;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(z||(z={}));class I extends Error{}const eo=(e,t,n)=>{let r=e.indexOf(t);for(;n-- >0&&r!==-1;)r=e.indexOf(t,r+t.length);return r},ke=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,qn=e=>{const t=at(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},et=e=>{const t=_e.empty();let n=7,r=0;for(let i=0;i<e.length;i++){const o=e[i];if(o==="/"&&r===8)r=0,n--;else{const s=parseInt(o,10);if(s>0)r+=s;else{if(r>=8||n<0)return _.err(new I(z.Board));const l=r+n*8,c=qn(o);if(!c)return _.err(new I(z.Board));e[i+1]==="~"&&(c.promoted=!0,i++),t.set(l,c),r++}}}return n!==0||r!==8?_.err(new I(z.Board)):_.ok(t)},Jt=e=>{if(e.length>64)return _.err(new I(z.Pockets));const t=ce.empty();for(const n of e){const r=qn(n);if(!r)return _.err(new I(z.Pockets));t[r.color][r.role]++}return _.ok(t)},to=(e,t)=>{let n=h.empty();if(t==="-")return _.ok(n);for(const r of t){const i=r.toLowerCase(),o=r===i?"black":"white",s=o==="white"?0:7;if("a"<=i&&i<="h")n=n.with(ct(i.charCodeAt(0)-97,s));else if(i==="k"||i==="q"){const l=e[o].intersect(h.backrank(o)).intersect(e.rook.union(e.king)),c=i==="k"?l.last():l.first();n=n.with(k(c)&&e.rook.has(c)?c:ct(i==="k"?7:0,s))}else return _.err(new I(z.Castling))}return he.some(r=>h.backrank(r).intersect(n).size()>2)?_.err(new I(z.Castling)):_.ok(n)},en=e=>{const t=e.split("+");if(t.length===3&&t[0]===""){const n=ke(t[1]),r=ke(t[2]);return!k(n)||n>3||!k(r)||r>3?_.err(new I(z.RemainingChecks)):_.ok(new De(3-n,3-r))}else if(t.length===2){const n=ke(t[0]),r=ke(t[1]);return!k(n)||n>3||!k(r)||r>3?_.err(new I(z.RemainingChecks)):_.ok(new De(n,r))}else return _.err(new I(z.RemainingChecks))},no=e=>{const t=e.split(/[\s_]+/),n=t.shift();let r,i=_.ok(void 0);if(n.endsWith("]")){const l=n.indexOf("[");if(l===-1)return _.err(new I(z.Fen));r=et(n.slice(0,l)),i=Jt(n.slice(l+1,-1))}else{const l=eo(n,"/",7);l===-1?r=et(n):(r=et(n.slice(0,l)),i=Jt(n.slice(l+1)))}let o;const s=t.shift();if(!k(s)||s==="w")o="white";else if(s==="b")o="black";else return _.err(new I(z.Turn));return r.chain(l=>{const c=t.shift(),a=k(c)?to(l,c):_.ok(h.empty()),d=t.shift();let u;if(k(d)&&d!=="-"&&(u=Ke(d),!k(u)))return _.err(new I(z.EpSquare));let b=t.shift(),w;k(b)&&b.includes("+")&&(w=en(b),b=t.shift());const p=k(b)?ke(b):0;if(!k(p))return _.err(new I(z.Halfmoves));const f=t.shift(),y=k(f)?ke(f):1;if(!k(y))return _.err(new I(z.Fullmoves));const m=t.shift();let g=_.ok(void 0);if(k(m)){if(k(w))return _.err(new I(z.RemainingChecks));g=en(m)}else k(w)&&(g=w);return t.length>0?_.err(new I(z.Fen)):i.chain(S=>a.chain(O=>g.map($=>({board:l,pockets:S,turn:o,castlingRights:O,remainingChecks:$,epSquare:u,halfmoves:p,fullmoves:Math.max(1,y)}))))})},ro=e=>{let t=xe(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},io=e=>{let t="",n=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const o=i+r*8,s=e.get(o);s?(n>0&&(t+=n,n=0),t+=ro(s)):n++,i===7&&(n>0&&(t+=n,n=0),r!==0&&(t+="/"))}return t},tn=e=>V.map(t=>xe(t).repeat(e[t])).join(""),oo=e=>tn(e.white).toUpperCase()+tn(e.black),so=(e,t)=>{let n="";for(const r of he){const i=h.backrank(r);let o=e.kingOf(r);k(o)&&!i.has(o)&&(o=void 0);const s=e.pieces(r,"rook").intersect(i);for(const l of t.intersect(i).reversed())if(l===s.first()&&k(o)&&l<o)n+=r==="white"?"Q":"q";else if(l===s.last()&&k(o)&&o<l)n+=r==="white"?"K":"k";else{const c=je[j(l)];n+=r==="white"?c.toUpperCase():c}}return n||"-"},lo=e=>`${e.white}+${e.black}`,co=(e,t)=>[io(e.board)+(e.pockets?`[${oo(e.pockets)}]`:""),e.turn[0],so(e.board,e.castlingRights),k(e.epSquare)?Re(e.epSquare):"-",...e.remainingChecks?[lo(e.remainingChecks)]:[],Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))].join(" "),ao=(e,t)=>{let n="";if(Ue(t))t.role!=="pawn"&&(n=xe(t.role).toUpperCase()),n+="@"+Re(t.to);else{const r=e.board.getRole(t.from);if(!r)return"--";if(r==="king"&&(e.board[e.turn].has(t.to)||Math.abs(t.to-t.from)===2))n=t.to>t.from?"O-O":"O-O-O";else{const i=e.board.occupied.has(t.to)||r==="pawn"&&j(t.from)!==j(t.to);if(r!=="pawn"){n=xe(r).toUpperCase();let o;if(r==="king"?o=Mt(t.to).intersect(e.board.king):r==="queen"?o=In(t.to,e.board.occupied).intersect(e.board.queen):r==="rook"?o=Te(t.to,e.board.occupied).intersect(e.board.rook):r==="bishop"?o=Oe(t.to,e.board.occupied).intersect(e.board.bishop):o=Rt(t.to).intersect(e.board.knight),o=o.intersect(e.board[e.turn]).without(t.from),o.nonEmpty()){const s=e.ctx();for(const l of o)e.dests(l,s).has(t.to)||(o=o.without(l));if(o.nonEmpty()){let l=!1,c=o.intersects(h.fromRank(de(t.from)));o.intersects(h.fromFile(j(t.from)))?l=!0:c=!0,c&&(n+=je[j(t.from)]),l&&(n+=Ln[de(t.from)])}}}else i&&(n=je[j(t.from)]);i&&(n+="x"),n+=Re(t.to),t.promotion&&(n+="="+xe(t.promotion).toUpperCase())}}return n},uo=(e,t)=>{var n;const r=ao(e,t);return e.play(t),!((n=e.outcome())===null||n===void 0)&&n.winner?r+"#":e.isCheck()?r+"+":r},ho=(e,t)=>uo(e.clone(),t),Tt=e=>e.split(" ").slice(0,-1).join(" "),Nt=e=>Fn.fromSetup(no(e).unwrap()).unwrap(),jn=e=>Nt(e).turn;function fo(e,t=Ot){let n=[],r=Nt(t),i;for(let o of e){let s=Ki(o),l=ho(r,s);r.play(s);let c=co(r.toSetup()),a=i?`${i.path} ${o}`:`${o}`,d=i?i.ply+1:1,u=i?.fen??t,b=i?.uci;i={path:a,ply:d,before_fen:u,fen:c,before_uci:b,uci:o,san:l},n.push(i)}return n}function po(e){let t=0;return n=>{t+=n.deltaY*(n.deltaMode?40:1),Math.abs(t)>=4?(e(n,!0),t=0):e(n,!1)}}var go=L('<div class="is2d chessboard"> ');function mo(e){let t,n,r=P(()=>{try{return Nt(e.fen)}catch{return Fn.default()}}),i=P(()=>Yi(r())),o=P(()=>r().isCheck());return nn(()=>{let s=e.color,l=r().isCheck(),c={fen:e.fen,check:l,premovable:{enabled:!1},movable:{color:s,free:!1,dests:i(),events:{after:e.play_orig_key}}};n=Ni(t,c)}),Le(()=>{let s;if(e.last_move){let[l]=e.last_move;s=[l.slice(0,2),l.slice(2,4)]}n.set({lastMove:s,fen:e.fen,turnColor:jn(e.fen),orientation:e.orientation??"white",check:o(),movable:{color:e.movable?e.color:void 0,dests:i()}})}),Le(()=>{n.setAutoShapes(e.shapes??[])}),(()=>{var s=go();return rn(l=>t=l,s),s})()}const bo=e=>({handleEvent:wo(e),passive:!1}),wo=e=>po(t=>{const n=t.target;n.tagName!=="PIECE"&&n.tagName!=="SQUARE"&&n.tagName!=="CG-BOARD"||(t.preventDefault(),e(Math.sign(t.deltaY)))});function Un(e,t={}){const n=t.storage||globalThis.localStorage,r=t.name||`storage-${tr()}`;if(!n)return[e[0],e[1],null];const i=t.storageOptions,o=t.serialize||JSON.stringify.bind(JSON),s=t.deserialize||JSON.parse.bind(JSON),l=n.getItem(r,i),c=typeof e[0]=="function"?d=>{try{const u=s(d);e[1](()=>u)}catch{}}:d=>{try{const u=s(d);e[1](nr(u))}catch{}};let a=!0;if(l instanceof Promise?l.then(d=>a&&d&&c(d)):l&&c(l),typeof t.sync?.[0]=="function"){const d=typeof e[0]=="function"?e[0]:()=>e[0];t.sync[0](u=>{u.key!==r||(u.url||globalThis.location.href)!==globalThis.location.href||u.newValue===o(Kt(d))||c(u.newValue)})}return[e[0],typeof e[0]=="function"?d=>{const u=e[1](d),b=d!=null?o(u):d;return t.sync?.[1](r,b),b!=null?n.setItem(r,b,i):n.removeItem(r,i),a=!1,u}:(...d)=>{e[1](...d);const u=o(Kt(()=>e[0]));t.sync?.[1](r,u),n.setItem(r,u,i),a=!1},l]}var vo=L('<div class=replay-tree><div class=moves-wrap><div class=moves></div></div><div class=replay-jump><button title=first class="fbt first"data-icon=></button><button title=previous class="fbt prev"data-icon=></button><button title=next class="fbt next"data-icon=></button><button title=last class="fbt last"data-icon=>'),ko=L('<div class=branch-sums><button title=up class="fbt up"data-icon=></button><button title=down class="fbt down"data-icon=>'),Gn=L("<span class=index>"),_o=L("<div class=fbt>"),yo=L("<div class=lines>"),Co=L("<div class=line>"),$o=L("<span class=collapsed>..<!> "),Po=L("<div class=move>"),Eo=L("<span class=nag>");function So(e){return Vn(e.steps_tree,e.cursor_path)}function xo(e,t){return N(e,Tt(t))}function Vn(e,t){let n=[],r=ve(e),i=r.length>1;if(t==="")return r;for(let o of t.split(" ")){let s=r.find(c=>c.step.uci===o);if(!s)return;i&&(n.push(s),i=!1);let l=N(e,s.step.path);l.length>1&&(i=!0),r=l}return n}function ve(e){return N(e,"")}function be(e,t){let n=J(e,t);return n?[J(e,Tt(t)),n]:void 0}function J(e,t){if(t==="")return;let n=Tt(t);return e.flat_nodes[n].find(o=>o.step.path===t)}function N(e,t){return e.flat_nodes[t]??[]}function Ao(e,t){let n=N(e,t.step.path);if(n.length>1)return 1;if(n.length===0)return 0;let r=1,i=n[0];for(;N(e,i.step.path).length===1;)r++,i=N(e,i.step.path)[0];return r}function Mo(e,t){return Ro(e,t)?.length??0}const Ro=(e,t)=>{let n=Qn(e,t);return n?N(e,n.step.path):void 0},Qn=(e,t)=>{let n=N(e,t.step.path);if(n.length!==0)return n.length===1?Qn(e,n[0]):t};function Zn(e){const t=P(()=>e.replay_tree.cursor_path),n=P(()=>e.replay_tree.steps_tree),r=P(()=>J(n(),"")?.step.fen??n().initial_fen??Ot),i=P(()=>J(n(),t())?.step.fen??r()),o=P(()=>{let p=J(n(),t())?.step;if(p)return[p.uci,p.san]});let s=[];Le(ir(t,p=>{Vn(n(),p)?.map(f=>{s.includes(f.step.path)||(xo(n(),f.step.path)?.forEach(y=>{s=s.filter(m=>m!==y.step.path)}),s.push(f.step.path))})}));const l=P(()=>{let p=t();if(p!=="")return p.split(" ").slice(0,-1).join(" ")}),c=P(()=>{let p=t(),f=N(n(),p);return f.length===1?f[0].step.path:f.find(y=>s.includes(y.step.path))?.step.path??f[0]?.step.path}),a=P(()=>{let p=be(n(),t());if(!p)return;let f=p;if(!f[0])return"";if(N(n(),f[0].step.path).length>1)return f[0].step.path;for(;!(!f[0]||N(n(),f[0].step.path).length>1);){let y=be(n(),f[0].step.path);if(!y)break;f=y}return f[1].step.path}),d=P(()=>{let p=J(n(),t());if(!p){let m=ve(n());return(m.find(g=>s.includes(g.step.path))??m[0])?.step.path}let f=p,y=N(n(),f.step.path);if(y.length>1)return y.find(m=>s.includes(m.step.path))?.step.path??y[0]?.step.path;for(;y.length===1;)f=y[0],y=N(n(),f.step.path);return f.step.path}),u=P(()=>{let p=be(n(),t());if(!p)return;let f=p[0]?N(n(),p[0].step.path):[];if(!p[0])f=ve(n());else if(N(n(),p[0].step.path).length===1)for(;;){if(p=be(n(),p[0].step.path),!p)return;if(!p[0]){f=ve(n());break}if(N(n(),p[0].step.path).length>1){f=N(n(),p[0].step.path);break}}let y=f.indexOf(p[1]),m=f[y-1];if(m)return m.step.path}),b=P(()=>{let p=be(n(),t());if(!p)return;let f=p[0]?N(n(),p[0].step.path):[];if(!p[0])f=ve(n());else if(N(n(),p[0].step.path).length===1)for(;;){if(p=be(n(),p[0].step.path),!p)return;if(!p[0]){f=ve(n());break}if(N(n(),p[0].step.path).length>1){f=N(n(),p[0].step.path);break}}let y=f.indexOf(p[1]),m=f[y+1];if(m)return m.step.path}),w=P(()=>J(e.replay_tree.steps_tree,t()));return{get initial_fen(){return r()},get fen(){return i()},get turn(){return jn(i())},get last_move(){return o()},get step_at_cursor_path(){return w()},get cursor_path(){return t()},get get_prev_path(){return l()},get get_next_path(){return c()},get get_first_path(){return a()},get get_last_path(){return d()},get get_down_path(){return b()},get get_up_path(){return u()}}}const Oo=e=>{let t=Zn(e);const n=d=>{e.handle_goto_path(d)},r=d=>{e.handle_goto_path(d)},i=d=>{n(d)},o=(d,u)=>{e.on_context_menu?.(d,u)};let s;Le(()=>{let d=e.replay_tree.cursor_path,u=s.parentElement;if(!u)return;const b=s.querySelector(".on-path-end");if(!b){u.scrollTop=d.length>0?99999:0;return}let w=b.offsetTop-u.offsetHeight/2+b.offsetHeight;u.scrollTo({behavior:"smooth",top:w})});const l=d=>{if(e.lose_focus)return;let u=!1;d.key==="ArrowLeft"&&(r(t.get_prev_path),u=!0),d.key==="ArrowRight"&&(r(t.get_next_path),u=!0),d.key==="ArrowUp"&&(r(t.get_up_path),u=!0),d.key==="ArrowDown"&&(r(t.get_down_path),u=!0),u&&d.preventDefault()};nn(()=>{document.addEventListener("keydown",l),or(()=>{document.removeEventListener("keydown",l)})});const c=Lt(()=>e.features),a=Lt(()=>e.feature_content);return(()=>{var d=vo(),u=d.firstChild,b=u.firstChild,w=u.nextSibling,p=w.firstChild,f=p.nextSibling,y=f.nextSibling,m=y.nextSibling;return rn(g=>s=g,b),E(b,x(mt,we({get replay_tree(){return e.replay_tree}},t,{on_set_cursor:i,on_context_menu:o,path:""}))),E(d,x(Y,{get when(){return a()},get fallback(){return(()=>{var g=ko(),S=g.firstChild,O=S.nextSibling;return S.$$click=()=>r(t.get_up_path),O.$$click=()=>r(t.get_down_path),E(g,x(Ae,{get each(){return So(e.replay_tree)},children:$=>(()=>{var D=_o();return D.$$click=()=>n($.step.path),E(D,x(Y,{get when(){return $.step.ply&1},get children(){var v=Gn();return E(v,()=>Xn($.step.ply)),v}}),null),E(D,()=>$.step.san,null),D})()}),null),re($=>{var D=t.get_up_path===void 0,v=t.get_up_path===void 0,C=t.get_down_path===void 0,A=t.get_down_path===void 0;return D!==$.e&&(S.disabled=$.e=D),v!==$.t&&S.classList.toggle("disabled",$.t=v),C!==$.a&&(O.disabled=$.a=C),A!==$.o&&O.classList.toggle("disabled",$.o=A),$},{e:void 0,t:void 0,a:void 0,o:void 0}),g})()},children:g=>g()}),w),E(w,x(Y,{get when(){return c()},children:g=>g()}),p),p.$$click=()=>r(t.get_first_path),f.$$click=()=>r(t.get_prev_path),y.$$click=()=>r(t.get_next_path),m.$$click=()=>r(t.get_last_path),re(g=>{var S=t.get_first_path===void 0,O=t.get_first_path===void 0,$=t.get_prev_path===void 0,D=t.get_prev_path===void 0,v=t.get_next_path===void 0,C=t.get_next_path===void 0,A=t.get_last_path===void 0,R=t.get_last_path===void 0;return S!==g.e&&(p.disabled=g.e=S),O!==g.t&&p.classList.toggle("disabled",g.t=O),$!==g.a&&(f.disabled=g.a=$),D!==g.o&&f.classList.toggle("disabled",g.o=D),v!==g.i&&(y.disabled=g.i=v),C!==g.n&&y.classList.toggle("disabled",g.n=C),A!==g.s&&(m.disabled=g.s=A),R!==g.h&&m.classList.toggle("disabled",g.h=R),g},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),d})()};function mt(e){const t=P(()=>e.replay_tree.steps_tree.flat_nodes[e.path]??[]);return[x(Y,{get when(){return t().length===1},get children(){return[x(tt,we(e,{get cursor_path(){return e.replay_tree.cursor_path},get node(){return t()[0]}})),x(mt,we(e,{get path(){return t()[0].step.path}}))]}}),x(Y,{get when(){return t().length>1},get children(){var n=yo();return E(n,x(Ae,{get each(){return t()},children:r=>(()=>{var i=Co();return E(i,x(Y,{get when(){return e.replay_tree.cursor_path.startsWith(r.step.path)},get fallback(){return[x(tt,we(e,{get cursor_path(){return e.replay_tree.cursor_path},node:r,show_index:!0,collapsed:!0})),x(To,{node:r,get replay_tree(){return e.replay_tree}})]},get children(){return[x(tt,we(e,{get cursor_path(){return e.replay_tree.cursor_path},node:r,show_index:!0})),x(mt,we(e,{get path(){return r.step.path}}))]}})),i})()})),n}})]}function To(e){return(()=>{var t=$o(),n=t.firstChild,r=n.nextSibling;return r.nextSibling,E(t,()=>Ao(e.replay_tree.steps_tree,e.node),r),E(t,()=>Mo(e.replay_tree.steps_tree,e.node),null),t})()}function tt(e){const t=P(()=>e.node.step);let n=P(()=>t().ply%2===1||e.show_index);const r=P(()=>t().path),i=P(()=>e.cursor_path.startsWith(r())),o=P(()=>r()===e.cursor_path),s=P(()=>({collapsed:e.collapsed,"on-path":i(),"on-path-end":o(),[No[e.node.nags?.[0]??0]]:e.node.nags!==void 0}));return(()=>{var l=Po();return l.$$click=()=>{e.on_set_cursor(t().path)},l.$$contextmenu=c=>{c.preventDefault(),e.on_context_menu(c,t().path)},E(l,x(Y,{get when(){return n()},get children(){var c=Gn();return E(c,()=>Xn(t().ply)),c}}),null),E(l,()=>t().san,null),E(l,x(Y,{get when(){return e.node.nags},children:c=>x(Do,{get nags(){return c()}})}),null),re(c=>rr(l,s(),c)),l})()}let Yn=["","!","?","!!","??","!?","?!"];Yn[22]="⨀";let No=["","good","mistake","top","blunder","interesting","inaccuracy"];const Do=e=>[" ",(()=>{var t=Eo();return E(t,()=>Yn[e.nags[0]]),t})()," "],Xn=e=>`${Math.ceil(e/2)}.`+(e%2===0?"..":"");on(["click","contextmenu"]);const zo=(e,t,n)=>Un(sn(e),{name:`.tactics-filter.v0.${t}`});class Dt{static create=t=>new Dt(t);get id(){return this.puzzle.id}get fen(){return this.puzzle.fen}get tags(){return this.puzzle.tags}_has_tags;get has_tags(){return this._has_tags||(this._has_tags=ln(this.puzzle)),this._has_tags}_all_tags;get all_tags(){return this._all_tags||(this._all_tags=wt(this.puzzle)),this._all_tags}constructor(t){this.puzzle=t}puzzle}var Ko=L('<main class=tactics-filter><div class=code-wrap></div><div class=list-wrap><div class=filter><input type=text placeholder="Filter1: y_filter _!_ n_filter"><input type=text placeholder="Filter2: y_filter _!_ n_filter"></div><div class=stats><span>/10000 Positions</span></div></div><div class=board-wrap></div><div class=replay-wrap><div class=tools><button>Copy FEN</button><button>Copy Puzzle ID'),Lo=L("<div class=progress> <!>/<!> "),Io=L("<div class=codebox><div class=rule-list><div class=scroll-wrap></div><div class=tools><div class=rule>+ New rule</div><div class=rule>- Delete rule</div></div></div><div class=text-wrap><textarea class=editor-input title=rules rows=13 cols=21></textarea><div class=ascii><textarea>"),Bo=L("<div><span class=name></span><span class=stats>f <!> / s "),Wo=L("<span>"),Fo=L("<div class=tactics-list><div class=list>"),Ho=L("<div class=item><a class=id target=_blank></a><div class=tags></div><div class=tags2>"),qo=L("<span class=tag>");function Qo(){const e=bt(),t=P(()=>e.puzzles??[]),[n,r]=Un(It({filter1:"",filter2:"",puzzle_id:""})),i=P(()=>Bt(n.filter1)),o=P(()=>Bt(n.filter2)),s=P(()=>t().filter(i()).filter(o())),l=P(()=>s().find(v=>v.id===n.puzzle_id)),c=v=>{v!==void 0&&w("cursor_path",v)},a=P(()=>{let v=l();return v?fo(v.moves.split(" "),v.fen):[]}),d=P(()=>{let v=a(),C={},A="";for(let R of v)C[A]||(C[A]=[]),C[A].push({step:R}),A=R.path;return C}),u=P(()=>({flat_nodes:d()})),[b,w]=It({get steps_tree(){return u()},cursor_path:""}),p=()=>"white",f=()=>J(b.steps_tree,b.cursor_path)?.step.fen??l()?.fen??Ot,y=()=>{let v=J(b.steps_tree,b.cursor_path);if(v)return[v.step.uci,v.step.san]},m=v=>{v!==void 0&&w("cursor_path",v)};let g=Zn({replay_tree:b});const S=v=>{v>0?m(g.get_next_path):m(g.get_prev_path)},O=v=>{rt(()=>{w("cursor_path",""),r("puzzle_id",v.id)}),setTimeout(()=>{m(g.get_next_path)},200)},$=()=>{navigator.clipboard.writeText(f())},D=()=>{let v=l()?.id;v&&navigator.clipboard.writeText(v)};return(()=>{var v=Ko(),C=v.firstChild,A=C.nextSibling,R=A.firstChild,T=R.firstChild,F=T.nextSibling,ge=R.nextSibling,ye=ge.firstChild,Ce=ye.firstChild,$e=A.nextSibling,Pe=$e.nextSibling,Jn=Pe.firstChild,zt=Jn.firstChild,er=zt.nextSibling;return E(C,x(Uo,{get fen(){return f()}})),T.$$input=Qe=>r("filter1",Qe.target.value),nt(T,"spellcheck",!1),F.$$input=Qe=>r("filter2",Qe.target.value),nt(F,"spellcheck",!1),E(ye,()=>s().length,Ce),E(A,x(Go,{get tactics(){return s().slice(0,1e3)},get selected_id(){return l()?.id},on_selected:O}),null),sr($e,"wheel",bo(S)),E($e,x(mo,{get color(){return p()},get fen(){return f()},get last_move(){return y()}})),zt.$$click=$,er.$$click=D,E(Pe,x(Oo,{handle_goto_path:c,lose_focus:!0,replay_tree:b}),null),E(v,x(jo,{}),null),re(()=>T.value=n.filter1),re(()=>F.value=n.filter2),v})()}const jo=()=>{const e=bt();return x(Y,{get when(){return e.progress},children:t=>(()=>{var n=Lo(),r=n.firstChild,i=r.nextSibling,o=i.nextSibling,s=o.nextSibling;return s.nextSibling,E(n,()=>t()[0],i),E(n,()=>t()[1],s),n})()})};function Uo(e){let t=bt();const n=P(lr(()=>t.all,Dt.create)),r=m=>n().filter(g=>g.all_tags[`failed_${m}`]).length,i=m=>n().filter(g=>g.all_tags[`solved_${m}`]).length;function o(){let m=1,g=`rule${m}`,S=s();for(;S.find(O=>O.name===g);)g=`rule${m++}`;return{name:g,rule:"",z:S.length}}const[s,l]=zo([{name:"rule1",rule:"",z:0}],"rule-list"),[c,a]=sn(0);t.rules(s());const d=P(()=>s()[c()]),u=m=>{if(m.key==="Escape"){let g=m.target.value,S=d(),O={name:S.name,rule:g,z:S.z},$=s(),D=$.findIndex(v=>v.name===S.name);$.splice(D,1,O),l([...$]),t.rules([O])}},b=()=>{rt(()=>{l([o(),...s()]),a(0)})},w=()=>{let m=s();if(m.length===1)return;let g=m.splice(c(),1);rt(()=>{l([...m]),c()===m.length&&a(m.length-1)}),t.rules(g.map(S=>({name:S.name,rule:"",z:-1})))};let p=cr(()=>ar.make(()=>mr)),f=P(()=>{const m=p();let g=d().rule;if(e.fen&&m){pr(m);try{return ur(e.fen,g)}catch(S){return"Error"+S}}});const y=P(()=>{let m=d();if(!(!m||!m.rule||!e.fen||!p()))return hr(m.rule,e.fen)});return(()=>{var m=Io(),g=m.firstChild,S=g.firstChild,O=S.nextSibling,$=O.firstChild,D=$.nextSibling,v=g.nextSibling,C=v.firstChild,A=C.nextSibling,R=A.firstChild;return E(S,x(Ae,{get each(){return s()},children:(T,F)=>(()=>{var ge=Bo(),ye=ge.firstChild,Ce=ye.nextSibling,$e=Ce.firstChild,Pe=$e.nextSibling;return Pe.nextSibling,ge.$$click=()=>a(F()),E(ye,()=>T.name),E(Ce,()=>r(T.name),Pe),E(Ce,()=>i(T.name),null),re(()=>dr(ge,"rule"+(F()===c()?" active":""))),ge})()})),$.$$click=b,D.$$click=w,C.$$keydown=u,R.disabled=!0,E(R,y),E(A,x(Y,{get when(){return f()},children:T=>(()=>{var F=Wo();return E(F,T),F})()}),null),re(()=>C.value=d()?.rule??"Select a rule"),m})()}function Go(e){const t=P(()=>e.tactics),n=fr(()=>e.selected_id);return(()=>{var r=Fo(),i=r.firstChild;return E(i,x(Ae,{get each(){return t()},children:o=>(()=>{var s=Ho(),l=s.firstChild,c=l.nextSibling,a=c.nextSibling;return s.$$click=()=>e.on_selected(o),E(l,()=>o.id),E(a,x(Ae,{get each(){return Object.keys(wt(o))},children:d=>(()=>{var u=qo();return E(u,d),u})()})),re(d=>{var u=!!n(o.id),b=o.link;return u!==d.e&&s.classList.toggle("active",d.e=u),b!==d.t&&nt(l,"href",d.t=b),d},{e:void 0,t:void 0}),s})()})),r})()}on(["input","click","keydown"]);export{Qo as default};
